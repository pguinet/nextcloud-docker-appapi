services:
  # ===========================================
  # Reverse Proxy - SSL automatique
  # ===========================================
  caddy:
    image: caddy:2-alpine
    container_name: nextcloud-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    environment:
      - NEXTCLOUD_DOMAIN=${NEXTCLOUD_DOMAIN}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - frontend
    depends_on:
      - nextcloud

  # ===========================================
  # Nextcloud - Application principale
  # ===========================================
  nextcloud:
    image: nextcloud:${NEXTCLOUD_VERSION:-30}-apache
    container_name: nextcloud-app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
      docker-socket-proxy:
        condition: service_started
    environment:
      # Base de données
      - POSTGRES_HOST=db
      - POSTGRES_DB=${POSTGRES_DB:-nextcloud}
      - POSTGRES_USER=${POSTGRES_USER:-nextcloud}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      
      # Redis
      - REDIS_HOST=redis
      
      # Configuration Nextcloud
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_DOMAIN}
      - TRUSTED_PROXIES=caddy
      - OVERWRITEPROTOCOL=https
      - OVERWRITECLIURL=https://${NEXTCLOUD_DOMAIN}
      - OVERWRITEHOST=${NEXTCLOUD_DOMAIN}
      
      # Admin initial
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER:-admin}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      
      # PHP
      - PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT:-1G}
      - PHP_UPLOAD_LIMIT=${PHP_UPLOAD_LIMIT:-10G}
    volumes:
      - nextcloud_html:/var/www/html
      - ./data/nextcloud:/var/www/html/data
    networks:
      - frontend
      - backend

  # ===========================================
  # PostgreSQL - Base de données
  # ===========================================
  db:
    image: postgres:16-alpine
    container_name: nextcloud-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-nextcloud}
      - POSTGRES_USER=${POSTGRES_USER:-nextcloud}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - ./data/db:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-nextcloud} -d ${POSTGRES_DB:-nextcloud}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Redis - Cache et File Locking
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: nextcloud-redis
    restart: unless-stopped
    command: redis-server --save 60 1 --loglevel warning
    volumes:
      - ./data/redis:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Cron - Tâches planifiées
  # ===========================================
  cron:
    image: nextcloud:${NEXTCLOUD_VERSION:-30}-apache
    container_name: nextcloud-cron
    restart: unless-stopped
    depends_on:
      - nextcloud
    entrypoint: /cron.sh
    volumes:
      - nextcloud_html:/var/www/html
      - ./data/nextcloud:/var/www/html/data
    networks:
      - backend

  # ===========================================
  # Docker Socket Proxy - Pour AppAPI
  # ===========================================
  # Proxy sécurisé qui filtre les appels Docker API
  # N'exposez JAMAIS le socket Docker directement !
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: nextcloud-docker-proxy
    restart: unless-stopped
    environment:
      # Permissions nécessaires pour AppAPI
      - CONTAINERS=1
      - IMAGES=1
      - NETWORKS=1
      - VOLUMES=1
      - POST=1
      - DELETE=1
      # Sécurité : désactiver le reste
      - AUTH=0
      - SECRETS=0
      - SWARM=0
      - BUILD=0
      - COMMIT=0
      - CONFIGS=0
      - DISTRIBUTION=0
      - EXEC=0
      - GRPC=0
      - NODES=0
      - PLUGINS=0
      - SERVICES=0
      - SESSION=0
      - SYSTEM=0
      - TASKS=0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - backend

# ===========================================
# Volumes
# ===========================================
volumes:
  nextcloud_html:
    name: nextcloud_html
  caddy_data:
    name: nextcloud_caddy_data
  caddy_config:
    name: nextcloud_caddy_config

# ===========================================
# Réseaux
# ===========================================
networks:
  frontend:
    name: nextcloud_frontend
  backend:
    name: nextcloud_backend
